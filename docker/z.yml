docker:
    defaults:
        compose:
            name: local
#            file: ~

tasks:
    # We need this for more than command, so use YML "inheritance" here.
    _docker.settings: &DOCKER_SETTINGS
        opts:
            default: docker.defaults.compose.file
            name: docker.defaults.compose.name
        set:
            _cmd: |
                cat(
                    "sudo COMPOSE_PROJECT_NAME=", name, " docker-compose ",
                    !is_file(cat(cwd, "/docker-compose.yml"))
                    ? cat(" -f ", default)
                    : ""
                )
    docker.up:
        <<: *DOCKER_SETTINGS
        help: |
            Put all containers for the local docker config up.
        flags:
            kill: false
            up: true
            bg: true
        args:
            container: ? ""
        pre:
            - sudo rm /var/www/localhost && ln $(VERBOSE ? "-v") -sf $(cwd)/$(is_dir("web") ? "web/") /var/www/localhost;
        do:
            - @(if kill) $(_cmd) kill $(container)
            - @(if up)   $(_cmd) up $(bg ? "-d") $(container)

    docker.build:
        <<: *DOCKER_SETTINGS
        help: |
            Builds the containers specified in the compose file
        args:
            container: ? ""
        do: $(_cmd) build $(container)

    docker.sh:
        <<: *DOCKER_SETTINGS
        help: |
            Opens a shell to a running container
        args:
            container: ? ""
            index: "1"
        do: @(with true as INTERACTIVE) sudo docker exec -ti $(name)_$(container)_$(index) "/bin/bash"

    docker.ps:
        <<: *DOCKER_SETTINGS
        help: |
            Show running processes
        do: $(_cmd) ps
